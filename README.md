# twn

Rustで記述された簡易的なスタックベース仮想マシンおよびアセンブラです。
独自の命令セット(`.twn`)をバイトコード(`.twnd`)に変換し、VM上で実行します。

## 構成

このプロジェクトは以下の3つのバイナリで構成されています。

- **`twnc`**: アセンブラ。ソースコード(`.twn`)をバイトコード(`.twnd`)にコンパイルします。
- **`twnvm`**: 仮想マシン。コンパイルされたバイトコードを実行します。
- **`twn`**: ドライバ。コンパイルから実行までを一括で行うラッパーコマンドです。

## ビルドとインストール

Rust環境が必要です。

```sh
cargo build --release
```

ビルド後、`target/release/`ディレクトリにバイナリが生成されます。
`twn`コマンドを使用する場合、`twnc`および`twnvm`がシステムのPATHに含まれている必要があります。

## 使い方

### 1. ソースコードの作成

拡張子 `.twn` のファイルを作成します（例: `example.twn`）。

```text
PUSH 10
PUSH 20
ADD
PRINT
FIN
```

### 2. 実行

**一括実行 (twnコマンド)**

ファイル名の拡張子を除いたベース名を引数に渡します。

```sh
# twnc, twnvmにPATHが通っている前提
twn example
```

**個別実行**

```sh
# コンパイル (example.twnd が生成される)
cargo run --bin twnc -- example.twn

# VMでの実行
cargo run --bin twnvm -- example.twnd
```

## 命令セット (Instruction Set)

大文字・小文字は区別されません。

| 命令             | オペコード | 説明                                                           |
| ---------------- | ---------- | -------------------------------------------------------------- |
| **スタック操作** |            |                                                                |
| `PUSH <val>`     | `0x01`     | 値をスタックにプッシュする                                     |
| `POP`            | `0x02`     | スタックから値をポップして破棄する                             |
| **算術演算**     |            | スタックから2つの値を取り出し演算結果をプッシュする (飽和演算) |
| `ADD`            | `0x10`     | 加算 (a + b)                                                   |
| `SUB`            | `0x11`     | 減算 (a - b)                                                   |
| `MUL`            | `0x12`     | 乗算 (a \* b)                                                  |
| `DIV`            | `0x13`     | 除算 (a / b)                                                   |
| `MOD`            | `0x14`     | 剰余 (a % b) ※即値として除数を取る実装の可能性あり要確認       |
| **即値演算**     |            | スタックの値と引数の値で演算する                               |
| `ADDI <val>`     | `0x15`     | 加算 (stack_val + val)                                         |
| `SUBI <val>`     | `0x16`     | 減算 (stack_val - val)                                         |
| `MULI <val>`     | `0x17`     | 乗算 (stack_val \* val)                                        |
| `DIVI <val>`     | `0x18`     | 除算 (stack_val / val)                                         |
| `MODI <val>`     | `0x19`     | 剰余 (stack_val % val)                                         |
| **制御構文**     |            |                                                                |
| `JZ <addr>`      | `0x20`     | スタックからポップし、値が0なら指定アドレスへジャンプ          |
| `JMZ <addr>`     | `0x21`     | 無条件ジャンプ (実装上は指定アドレスへ強制移動)                |
| `FIN`            | `0xFF`     | プログラムを終了する                                           |
| **メモリ操作**   |            | メモリサイズは256バイト                                        |
| `STORE <addr>`   | `0x30`     | スタックからポップした値を指定アドレスのメモリに保存           |
| `LOAD <addr>`    | `0x31`     | 指定アドレスのメモリから値を読み出しスタックにプッシュ         |
| **デバッグ・IO** |            |                                                                |
| `PRINT`          | `0x90`     | スタックトップの値を表示してポップする                         |
| `DUMP`           | `0x91`     | 現在のスタックの状態をすべて表示する (デバッグ用)              |

### ラベル

末尾に `:` を付けることでラベルを定義できます。ジャンプ命令の宛先として使用可能です。

```text
PUSH 0
Loop:
    ADDI 1
    DUMP
    // ... 条件分岐など
    JMZ Loop
```

## ライセンス

[LICENSE](https://www.google.com/search?q=LICENSE) を参照してください。
